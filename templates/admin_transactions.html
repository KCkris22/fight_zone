{% extends "base_admin.html" %}
{% block content %}

<div class="admin-page-wrapper">

    <!-- TOP PAGE NAV -->
    <div class="admin-section-nav">
        <a href="{{ url_for('admin_dashboard') }}" class="section-btn">Manage Users</a>
        <a href="{{ url_for('admin_transactions') }}" class="section-btn active">Transactions</a>
    </div>

    <h2 class="admin-title">All Transactions (Membership + Store)</h2>

    <div class="admin-table-box">
        <table class="admin-table">
            <thead>
            <tr>
                <th>ID</th>
                <th>Type</th>
                <th>User</th>
                <th>Payment Method</th>
                <th>Item</th>
                <th>Price</th>
                <th>Proof</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
            </thead>

            <tbody>
            {% for t in transactions %}
            <tr>
                <td>{{ t.id }}</td>
                <td>{{ t.type|capitalize }}</td>
                <td>{{ t.username }}</td>
                <td>{{ (t.payment_method or '').upper() }}</td>

                <!-- Option 1 display: "Type — Item" will be shown in the Item column as requested -->
                <td style="max-width:260px; white-space:normal;">
                    {{ t.type|capitalize }} — {{ t.item }}
                </td>

                <td>₱{{ t.price }}</td>

                <td>
                    {% if t.proof %}
                        {% if t.proof.endswith('.pdf') %}
                            <a href="{{ url_for('static', filename='payment_proofs/' ~ t.proof) }}" target="_blank">Open PDF</a>
                        {% else %}
                            <img src="{{ url_for('static', filename='payment_proofs/' ~ t.proof) }}"
                                 style="width:90px; border:2px solid red; border-radius:6px;">
                        {% endif %}
                    {% else %}
                        No Proof
                    {% endif %}
                </td>

                <td>{{ t.status or 'Pending' }}</td>

                <td>
                    <!-- Use modal confirmation instead of native confirm() -->
                    <a href="#" onclick="openConfirmModal('accept','{{ t.type }}', {{ t.id }}, '{{ (t.item|e) }}')"
                       style="color:black; background:red; padding:6px 10px; border-radius:6px; text-decoration:none; display:inline-block; margin-right:6px;">
                        Accept
                    </a>

                    <a href="#" onclick="openConfirmModal('reject','{{ t.type }}', {{ t.id }}, '{{ (t.item|e) }}')"
                       style="color:white; background:#550000; padding:6px 10px; border-radius:6px; text-decoration:none; display:inline-block; margin-right:6px;">
                        Reject
                    </a>

                    <a href="#" onclick="openConfirmModal('delete','{{ t.type }}', {{ t.id }}, '{{ (t.item|e) }}')"
                       style="color:red; background:black; padding:6px 10px; border-radius:6px; text-decoration:none; display:inline-block;">
                        Delete
                    </a>
                </td>
            </tr>
            {% endfor %}
            </tbody>

        </table>
    </div>
</div>

<!-- Confirmation Modal (black/red themed) -->
<div id="confirmModal" class="confirm-modal" style="display:none;">
    <div class="confirm-box">
        <h3 id="confirmTitle">Confirm action</h3>
        <p id="confirmMessage" style="margin-bottom:18px;"></p>

        <div class="confirm-actions">
            <a id="confirmYes" href="#" class="confirm-yes">Yes</a>
            <button onclick="closeConfirmModal()" class="confirm-no">Cancel</button>
        </div>
    </div>
</div>

<style>
/* Page container */
.admin-page-wrapper { width:85%; max-width:1200px; margin:30px auto 60px auto; text-align:center; }

/* Nav */
.admin-section-nav { display:flex; justify-content:center; gap:18px; margin-bottom:25px; }
.section-btn { background:#0d0d0d; border:2px solid red; padding:10px 20px; color:red; font-weight:bold; border-radius:8px; text-decoration:none; }
.section-btn.active { background:red; color:black; }

/* title */
.admin-title { color:red; margin-bottom:20px; text-shadow:0 0 10px red; }

/* table box */
.admin-table-box { background:#0d0d0d; border:3px solid red; padding:14px; border-radius:12px; box-shadow:0 0 16px red; }
.admin-table { width:100%; border-collapse:collapse; table-layout:auto; }
.admin-table th { background:red; color:black; padding:10px; text-align:center; }
.admin-table td { padding:10px; border-bottom:1px solid rgba(255,0,0,0.15); vertical-align:middle; text-align:center; }

/* proof image */
.proof-img { width:140px; border:2px solid red; border-radius:8px; display:block; margin:6px auto; }

/* modal */
.confirm-modal {
    position: fixed;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    background: rgba(0,0,0,0.7);
    z-index:12000;
}
.confirm-box {
    width:420px;
    background:#0d0d0d;
    border:2px solid red;
    padding:20px;
    border-radius:12px;
    color:white;
    text-align:center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.6);
}
.confirm-box h3 { color:#ff4444; margin-bottom:10px; }
.confirm-actions { display:flex; gap:12px; justify-content:center; margin-top:6px; }
.confirm-yes {
    background: red;
    color: black;
    padding:8px 14px;
    border-radius:8px;
    text-decoration:none;
    font-weight:800;
}
.confirm-no {
    background:#333;
    color:white;
    padding:8px 14px;
    border-radius:8px;
    border:none;
    cursor:pointer;
}
</style>

<script>
// Shows the confirm modal and wires the "Yes" button to the right endpoint.
function openConfirmModal(action, typ, id, item) {
    // action: 'accept'|'reject'|'delete'
    document.getElementById('confirmModal').style.display = 'flex';
    const title = document.getElementById('confirmTitle');
    const msg = document.getElementById('confirmMessage');
    const yes = document.getElementById('confirmYes');

    const prettyItem = (item || '').replace(/'/g, "\\'");

    if (action === 'accept') {
        title.innerText = 'Accept Payment';
        msg.innerText = `Accept this ${typ} payment for "${prettyItem}" ?`;
        yes.href = `/admin/transactions/accept/${typ}/${id}`;
    } else if (action === 'reject') {
        title.innerText = 'Reject Payment';
        msg.innerText = `Reject this ${typ} payment for "${prettyItem}" ?`;
        yes.href = `/admin/transactions/reject/${typ}/${id}`;
    } else if (action === 'delete') {
        title.innerText = 'Delete Record';
        msg.innerText = `Delete this ${typ} record for "${prettyItem}" permanently? This cannot be undone.`;
        yes.href = `/admin/transactions/delete/${typ}/${id}`;
    }
}

function closeConfirmModal(){
    document.getElementById('confirmModal').style.display = 'none';
}
</script>

{% endblock %}