{% extends "base_admin.html" %}

{% block content %}

<!-- ---------- TOP BAR FLOATING ABOVE PAGE ---------- -->
<div class="admin-topbar">
    <div class="admin-top-buttons">
        <a href="{{ url_for('admin_dashboard') }}" class="admin-btn">Manage Users</a>
        <a href="{{ url_for('admin_subscriptions') }}" class="admin-btn">Transactions</a>
    </div>
</div>

<!-- ---------- MAIN PAGE CONTENT ---------- -->
<div class="admin-section">
    <h2>Registered Users Database</h2>

    <!-- SEARCH + ADD -->
    <div class="top-controls">
        <input id="searchInput" class="search-bar" placeholder="Search...">
        <button class="add-btn" onclick="openAddUser()">Add User</button>
    </div>

    <!-- TABLE -->
    <div class="table-wrapper">
        <table id="userTable">
            <tr>
                <th>ID</th>
                <th>First Name</th>
                <th>Last Name</th>
                <th>Address</th>
                <th>Email</th>
                <th>Password</th>
                <th>Actions</th>
            </tr>

            {% for user in users %}
            <tr
                data-id="{{ user.id }}"
                data-firstname="{{ user.first_name }}"
                data-lastname="{{ user.last_name }}"
                data-address="{{ user.address }}"
                data-email="{{ user.email }}"
                data-password="{{ user.password }}"
            >
                <td>{{ user.id }}</td>
                <td>{{ user.first_name }}</td>
                <td>{{ user.last_name }}</td>
                <td>{{ user.address }}</td>
                <td>{{ user.email }}</td>
                <td class="password-cell">{{ user.password }}</td>
                <td>
                    <button class="action-btn edit-btn" onclick="openEditUser({{ user.id }})">Edit</button>
                    <button class="action-btn delete-btn" onclick="openDeleteConfirm({{ user.id }})">Delete</button>
                </td>
            </tr>
            {% endfor %}
        </table>
    </div>
</div>

<!-- ---------- ADD USER MODAL ---------- -->
<div id="addModal" class="modal-bg">
    <div class="modal-box">
        <h3>Add User</h3>
        <input id="addFirst" class="modal-input" placeholder="First Name">
        <input id="addLast" class="modal-input" placeholder="Last Name">
        <input id="addAddress" class="modal-input" placeholder="Address">
        <input id="addEmail" class="modal-input" placeholder="Email">
        <input id="addPassword" class="modal-input" placeholder="Password">
        <button class="modal-btn yes-btn" onclick="submitAdd()">Create</button>
        <button class="modal-btn no-btn" onclick="closeAdd()">Cancel</button>
    </div>
</div>

<!-- ---------- EDIT USER MODAL ---------- -->
<div id="editModal" class="modal-bg">
    <div class="modal-box">
        <h3>Edit User</h3>
        <input id="editFirst" class="modal-input" placeholder="First Name">
        <input id="editLast" class="modal-input" placeholder="Last Name">
        <input id="editAddress" class="modal-input" placeholder="Address">
        <input id="editEmail" class="modal-input" placeholder="Email">
        <button class="modal-btn yes-btn" id="editSave">Save</button>
        <button class="modal-btn no-btn" onclick="closeEdit()">Cancel</button>
    </div>
</div>

<!-- ---------- DELETE CONFIRM MODAL ---------- -->
<div id="deleteModal" class="modal-bg">
    <div class="modal-box">
        <h3>Are you sure you want to delete this account?</h3>
        <button class="modal-btn yes-btn" id="deleteYes">Yes</button>
        <button class="modal-btn no-btn" onclick="closeDelete()">No</button>
    </div>
</div>

<!-- ---------- CSS ---------- -->
<style>
/* TOP BAR FLOATING */
.admin-topbar {
    position: fixed;
    top: 100px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    justify-content: flex-start;
    align-items: center;
    padding: 15px 20px;
    background: rgba(0,0,0,0.9);
    border: 2px solid red;
    border-radius: 8px;
    z-index: 999;
    gap: 10px;
}

.admin-top-buttons .admin-btn {
    background: red;
    color: black;
    padding: 10px 16px;
    text-decoration: none;
    font-weight: bold;
    border-radius: 6px;
    transition: 0.2s ease;
}

.admin-top-buttons .admin-btn:hover {
    background: #ff4d4d;
    box-shadow: 0 0 10px red;
}

/* MAIN CONTAINER */
.admin-section {
    width: 80%;
    max-width: 1100px;
    background: rgba(0, 0, 0, 0.75);
    border: 2px solid red;
    border-radius: 12px;
    padding: 20px;
    margin: 100px auto 40px auto;
    box-shadow: 0 0 20px red;
}

/* HEADING */
h2 {
    text-align: center;
    color: red;
    text-shadow: 0 0 10px red;
    margin-bottom: 20px;
}

/* TOP CONTROLS */
.top-controls {
    display: flex;
    justify-content: space-between;
    margin-bottom: 15px;
}

.search-bar {
    width: 60%;
    padding: 10px;
    background: black;
    color: white;
    border: 2px solid red;
    border-radius: 6px;
    box-shadow: 0 0 10px red;
}

.add-btn {
    background: red;
    color: black;
    padding: 10px 15px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-weight: bold;
}
.add-btn:hover {
    background: #ff5050;
    box-shadow: 0 0 12px red;
}

/* TABLE */
.table-wrapper {
    width: 100%;
    max-height: 350px;
    overflow-x: auto;
    overflow-y: auto;
    border: 2px solid red;
    padding: 5px;
    border-radius: 10px;
    box-shadow: 0 0 10px red;
}

table {
    width: 100%;
    border-collapse: collapse;
}

th {
    background: red;
    color: black;
    padding: 10px;
}

td {
    padding: 8px;
    text-align: center;
    background: rgba(40,0,0,0.7);
    border-bottom: 1px solid #550000;
}

td, th { white-space: nowrap; }

.action-btn {
    padding: 6px 10px;
    border-radius: 6px;
    cursor: pointer;
    border: none;
    font-weight: bold;
}

.edit-btn { background: #ff9900; }
.edit-btn:hover { background: #ffb84d; box-shadow: 0 0 10px orange; }

.delete-btn { background: #cc0000; color: white; }
.delete-btn:hover { background: #ff3333; box-shadow: 0 0 10px red; }

/* MODALS */
.modal-bg {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.85);
    display: none;
    justify-content: center;
    align-items: center;
}

.modal-box {
    width: 400px;
    background: black;
    border: 2px solid red;
    box-shadow: 0 0 20px red;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    color: white;
}

.modal-input {
    width: 90%;
    padding: 10px;
    margin-bottom: 12px;
    background: #111;
    border: 1px solid red;
    color: white;
    border-radius: 6px;
}

.modal-btn {
    padding: 10px 18px;
    margin: 5px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
}

.yes-btn { background: red; }
.yes-btn:hover { background: #ff5050; box-shadow: 0 0 10px red; }

.no-btn { background: #444; color: white; }
.no-btn:hover { background: #666; }
</style>

<!-- ---------- JAVASCRIPT ---------- -->
<script>
/* DELETE */
let deleteUserId = null;
function openDeleteConfirm(id) {
    deleteUserId = id;
    document.getElementById("deleteModal").style.display = "flex";
}
function closeDelete() {
    document.getElementById("deleteModal").style.display = "none";
}
document.getElementById("deleteYes")?.addEventListener("click", function() {
    window.location.href = `/admin/delete_user/${deleteUserId}`;
});

/* EDIT */
let editUserId = null;
function openEditUser(id) {
    editUserId = id;
    const row = document.querySelector(`tr[data-id='${id}']`);
    document.getElementById("editFirst").value = row.dataset.firstname;
    document.getElementById("editLast").value = row.dataset.lastname;
    document.getElementById("editAddress").value = row.dataset.address;
    document.getElementById("editEmail").value = row.dataset.email;
    document.getElementById("editModal").style.display = "flex";
}
function closeEdit() { document.getElementById("editModal").style.display = "none"; }
document.getElementById("editSave")?.addEventListener("click", function () {
    const f = document.getElementById("editFirst").value;
    const l = document.getElementById("editLast").value;
    const a = document.getElementById("editAddress").value;
    const e = document.getElementById("editEmail").value;
    window.location.href = `/admin/edit_user/${editUserId}?first_name=${f}&last_name=${l}&address=${a}&email=${e}`;
});

/* ADD */
function openAddUser() { document.getElementById("addModal").style.display = "flex"; }
function closeAdd() { document.getElementById("addModal").style.display = "none"; }
function submitAdd() {
    const f = document.getElementById("addFirst").value;
    const l = document.getElementById("addLast").value;
    const a = document.getElementById("addAddress").value;
    const e = document.getElementById("addEmail").value;
    const p = document.getElementById("addPassword").value;
    window.location.href = `/admin/add_user?first_name=${f}&last_name=${l}&address=${a}&email=${e}&password=${p}`;
}

/* LIVE SEARCH */
document.getElementById("searchInput")?.addEventListener("keyup", () => {
    const term = searchInput.value.toLowerCase();
    document.querySelectorAll("#userTable tr").forEach((row, i) => {
        if (i === 0) return;
        row.style.display = row.innerText.toLowerCase().includes(term) ? "" : "none";
    });
});
</script>

{% endblock %}