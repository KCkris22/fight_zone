{% extends "base_admin.html" %}
{% block content %}

<div class="admin-page-wrapper">

    <!-- TOP PAGE NAV BUTTONS (centered) -->
    <div class="admin-section-nav">
        <a href="{{ url_for('admin_dashboard') }}" class="section-btn">Manage Users</a>
        <a href="{{ url_for('admin_subscriptions') }}" class="section-btn active">Transactions</a>
    </div>

    <!-- PAGE TITLE -->
    <h2 class="admin-title">Membership & Store Transactions</h2>

    <!-- TABLE -->
    <div class="admin-table-box">
        <table class="admin-table">
            <thead>
            <tr>
                <th>ID</th>
                <th>Type</th>
                <th>User</th>
                <th>Email</th>
                <th>Payment Method</th>
                <th>Item / Plan</th>
                <th>Price</th>
                <th>Proof</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            {% for s in subs %}
            <tr>
                <td>{{ s.id }}</td>
                <td>{{ s.type|capitalize }}</td>
                <td>{{ s.requester_username or 'N/A' }}</td>
                <td>{{ s.requester_email or 'N/A' }}</td>
                <td>{{ (s.payment_method or '').upper() }}</td>

                <!-- Option 1: show Type — Item -->
                <td style="max-width:220px; white-space:normal;">{{ s.type|capitalize }} — {{ s.item }}</td>

                <td>₱{{ s.price }}</td>

                <td>
                    {% if s.proof %}
                    <details>
                        <summary class="proof-summary">View proof</summary>

                        {% set pf = s.proof %}
                        {% if pf.endswith('.pdf') %}
                        <a href="{{ url_for('static', filename='payment_proofs/' ~ pf) }}" target="_blank" class="view-btn">Open PDF</a><br>
                        <a href="{{ url_for('static', filename='payment_proofs/' ~ pf) }}" download class="view-btn">Download PDF</a>
                        {% else %}
                        <img src="{{ url_for('static', filename='payment_proofs/' ~ pf) }}" class="proof-img">
                        <div><a href="{{ url_for('static', filename='payment_proofs/' ~ pf) }}" target="_blank" class="view-btn">Open image</a></div>
                        {% endif %}
                    </details>
                    {% else %}
                    No Proof
                    {% endif %}
                </td>

                <td class="status-col">{{ s.status or 'Pending' }}</td>

                <td class="actions-col">
                    {% set t = s.type %}
                    {% if (s.status or '').lower() != 'accepted' %}
                    <a href="#" class="action-accept"
                       onclick="openConfirmModal('accept','{{ t }}', {{ s.id }}, '{{ (s.item|e) }}')">Accept</a>
                    {% else %}
                    <span class="accepted-label">Accepted</span>
                    {% endif %}

                    {% if (s.status or '').lower() != 'rejected' %}
                    <a href="#" class="action-reject"
                       onclick="openConfirmModal('reject','{{ t }}', {{ s.id }}, '{{ (s.item|e) }}')">Reject</a>
                    {% endif %}

                    <button class="action-edit" onclick="openEditModal({{ s.id }}, '{{ s.item|e }}', '{{ s.price }}')">
                        Edit
                    </button>

                    <!-- Delete -->
                    <a href="#" class="action-delete"
                       onclick="openConfirmModal('delete','{{ t }}', {{ s.id }}, '{{ (s.item|e) }}')">Delete</a>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- EDIT SUBSCRIPTION MODAL -->
<div id="editModal" class="modal-bg">
    <div class="modal-box">
        <h3>Edit Entry (Membership only)</h3>
        <form id="editForm" method="POST" action="{{ url_for('edit_subscription_post') }}">
            <input type="hidden" name="id" id="editId">
            <label>Plan / Product</label>
            <input type="text" name="plan" id="editPlan" class="modal-input">
            <label>Price</label>
            <input type="text" name="price" id="editPrice" class="modal-input">
            <label>Status</label>
            <select name="status" id="editStatus" class="modal-input">
                <option value="Pending">Pending</option>
                <option value="Accepted">Accepted</option>
                <option value="Rejected">Rejected</option>
            </select>
            <div style="margin-top:12px;">
                <button type="submit" class="modal-btn yes-btn">Save</button>
                <button type="button" class="modal-btn no-btn" onclick="closeEditModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Reuse same confirm modal used in transactions page -->
<div id="confirmModal" class="confirm-modal" style="display:none;">
    <div class="confirm-box">
        <h3 id="confirmTitle">Confirm action</h3>
        <p id="confirmMessage" style="margin-bottom:18px;"></p>

        <div class="confirm-actions">
            <a id="confirmYes" href="#" class="confirm-yes">Yes</a>
            <button onclick="closeConfirmModal()" class="confirm-no">Cancel</button>
        </div>
    </div>
</div>

<style>
    /* Centering & nav */
    .admin-page-wrapper { width:85%; max-width:1200px; margin:30px auto 60px auto; text-align:center; }
    .admin-section-nav { display:flex; justify-content:center; gap:18px; margin-bottom:25px; }
    .section-btn { background:#0d0d0d; border:2px solid red; padding:10px 20px; color:red; font-weight:bold; border-radius:8px; text-decoration:none; }
    .section-btn.active { background:red; color:black; }

    .admin-title { color:red; margin-bottom:20px; text-shadow:0 0 10px red; }
    .admin-table-box { background:#0d0d0d; border:3px solid red; padding:14px; border-radius:12px; box-shadow:0 0 16px red; }
    .admin-table { width:100%; border-collapse:collapse; table-layout:auto; }
    .admin-table th { background:red; color:black; padding:10px; text-align:center; }
    .admin-table td { padding:10px; border-bottom:1px solid rgba(255,0,0,0.15); vertical-align:middle; text-align:center; }

    .proof-img { width:140px; border:2px solid red; border-radius:8px; display:block; margin:6px auto; }
    .proof-summary { cursor:pointer; color:#fff; background:#111; border:1px solid #660000; padding:6px 10px; border-radius:6px; }

    .action-accept { background:red; color:black; padding:6px 10px; border-radius:6px; text-decoration:none; }
    .action-reject { background:#550000; color:white; padding:6px 10px; border-radius:6px; text-decoration:none; border:1px solid red; }
    .action-delete { background:black; color:red; padding:6px 10px; border-radius:6px; text-decoration:none; border:1px solid red; }
    .action-edit { background:#ff9900; color:black; padding:6px 10px; border-radius:6px; cursor:pointer; border:none; }

    .accepted-label { color:#000; background:#ffb84d; padding:6px 8px; border-radius:6px; font-weight:bold; }

    /* Edit modal */
    .modal-bg { position:fixed; inset:0; display:none; justify-content:center; align-items:center; background: rgba(0,0,0,0.75); z-index:1200; }
    .modal-box { width:420px; background:#0d0d0d; border:2px solid red; padding:18px; border-radius:12px; color:white; text-align:left; }
    .modal-input { width:100%; padding:10px; margin:8px 0; background:#111; border:1px solid red; color:white; border-radius:6px; }
    .modal-btn { padding:10px 14px; border-radius:6px; border:none; font-weight:bold; cursor:pointer; }
    .yes-btn { background:red; } .no-btn { background:#333; color:white; }

    /* Confirm modal (same as transactions page) */
    .confirm-modal { position: fixed; inset:0; display:flex; align-items:center; justify-content:center; background: rgba(0,0,0,0.7); z-index:12000; }
    .confirm-box { width:420px; background:#0d0d0d; border:2px solid red; padding:20px; border-radius:12px; color:white; text-align:center; box-shadow: 0 10px 30px rgba(0,0,0,0.6); }
    .confirm-box h3 { color:#ff4444; margin-bottom:10px; }
    .confirm-actions { display:flex; gap:12px; justify-content:center; margin-top:6px; }
    .confirm-yes { background: red; color: black; padding:8px 14px; border-radius:8px; text-decoration:none; font-weight:800; }
    .confirm-no { background:#333; color:white; padding:8px 14px; border-radius:8px; border:none; cursor:pointer; }
</style>

<script>
    function openEditModal(id, plan, price){
        document.getElementById('editId').value = id;
        document.getElementById('editPlan').value = plan || '';
        document.getElementById('editPrice').value = price || '';
        document.getElementById('editStatus').value = 'Pending';
        document.getElementById('editModal').style.display = 'flex';
    }
    function closeEditModal(){
        document.getElementById('editModal').style.display = 'none';
    }

    // Confirm modal functions (reused)
    function openConfirmModal(action, typ, id, item) {
        document.getElementById('confirmModal').style.display = 'flex';
        const title = document.getElementById('confirmTitle');
        const msg = document.getElementById('confirmMessage');
        const yes = document.getElementById('confirmYes');

        const prettyItem = (item || '').replace(/'/g, "\\'");

        if (action === 'accept') {
            title.innerText = 'Accept Payment';
            msg.innerText = `Accept this ${typ} payment for "${prettyItem}" ?`;
            yes.href = `/admin/transactions/accept/${typ}/${id}`;
        } else if (action === 'reject') {
            title.innerText = 'Reject Payment';
            msg.innerText = `Reject this ${typ} payment for "${prettyItem}" ?`;
            yes.href = `/admin/transactions/reject/${typ}/${id}`;
        } else if (action === 'delete') {
            title.innerText = 'Delete Record';
            msg.innerText = `Delete this ${typ} record for "${prettyItem}" permanently? This cannot be undone.`;
            yes.href = `/admin/transactions/delete/${typ}/${id}`;
        }
    }

    function closeConfirmModal(){
        document.getElementById('confirmModal').style.display = 'none';
    }
</script>

{% endblock %}