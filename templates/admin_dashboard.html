{% extends "base_admin.html" %}

{% block content %}

<style>

    @keyframes fadeIn {
        from {opacity: 0; transform: scale(0.95);}
        to {opacity: 1; transform: scale(1);}
    }

    .admin-section {
        width: 80%;
        max-width: 1100px;
        background: rgba(0, 0, 0, 0.75);
        border: 2px solid red;
        border-radius: 12px;
        padding: 20px;
        margin-top: 40px;
        animation: fadeIn 0.4s ease-out;
        box-shadow: 0 0 20px red;
    }

    h2 {
        text-align: center;
        color: red;
        text-shadow: 0 0 10px red;
        margin-bottom: 20px;
    }

    .top-controls {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
    }

    .search-bar {
        width: 60%;
        padding: 10px;
        background: black;
        color: white;
        border: 2px solid red;
        border-radius: 6px;
        box-shadow: 0 0 10px red;
    }

    .add-btn {
        background: red;
        color: black;
        padding: 10px 15px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-weight: bold;
    }
    .add-btn:hover {
        background: #ff5050;
        box-shadow: 0 0 12px red;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }

    th {
        background: red;
        color: black;
        padding: 10px;
    }

    td {
        padding: 8px;
        text-align: center;
        background: rgba(40,0,0,0.7);
        border-bottom: 1px solid #550000;
    }

    .action-btn {
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        border: none;
        font-weight: bold;
    }

    .edit-btn { background: #ff9900; }
    .edit-btn:hover { background: #ffb84d; box-shadow: 0 0 10px orange; }

    .delete-btn { background: #cc0000; color: white; }
    .delete-btn:hover { background: #ff3333; box-shadow: 0 0 10px red; }

    /* MODAL STYLING */
    .modal-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.85);
        display: none;
        justify-content: center;
        align-items: center;
    }

    .modal-box {
        width: 400px;
        background: black;
        border: 2px solid red;
        box-shadow: 0 0 20px red;
        border-radius: 12px;
        padding: 20px;
        animation: fadeIn 0.2s;
        color: white;
        text-align: center;
    }

    .modal-input {
        width: 90%;
        padding: 10px;
        margin-bottom: 12px;
        background: #111;
        border: 1px solid red;
        color: white;
        border-radius: 6px;
    }

    .modal-btn {
        padding: 10px 18px;
        margin: 5px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
    }

    .yes-btn { background: red; }
    .yes-btn:hover { background: #ff5050; box-shadow: 0 0 10px red; }

    .no-btn { background: #444; color: white; }
    .no-btn:hover { background: #666; }

    .table-wrapper {
    width: 100%;
    max-height: 350px;
    overflow-x: auto;
    overflow-y: auto;
    border: 2px solid red;
    padding: 5px;
    border-radius: 10px;
    box-shadow: 0 0 10px red;
}

td, th {
    white-space: nowrap;
}

</style>

<div class="admin-section">

    <h2>Registered Users Database</h2>

    <div class="top-controls">
        <input id="searchInput" class="search-bar" placeholder="Search...">
        <button class="add-btn" onclick="openAddUser()">Add User</button>
    </div>

    <div class="table-wrapper">
    <table id="userTable">
        <tr>
            <th>ID</th><th>Username</th><th>Email</th><th>Password</th><th>Actions</th>
        </tr>

        {% for user in users %}
        <tr data-id="{{ user.id }}" data-username="{{ user.username }}" data-email="{{ user.email }}" data-password="{{ user.password }}">
            <td>{{ user.id }}</td>
            <td>{{ user.username }}</td>
            <td>{{ user.email }}</td>
            <td class="password-cell">{{ user.password }}</td>
            <td>
                <button class="action-btn edit-btn" onclick="openEditUser({{ user.id }})">Edit</button>
                <button class="action-btn delete-btn" onclick="openDeleteConfirm({{ user.id }})">Delete</button>
            </td>
        </tr>
        {% endfor %}
    </table>
</div>


<!-- DELETE CONFIRM MODAL -->
<div id="deleteModal" class="modal-bg">
    <div class="modal-box">
        <h3>Are you sure you want to delete this account?</h3>
        <button class="modal-btn yes-btn" id="deleteYes">Yes</button>
        <button class="modal-btn no-btn" onclick="closeDelete()">No</button>
    </div>
</div>

<!-- EDIT USER MODAL -->
<div id="editModal" class="modal-bg">
    <div class="modal-box">
        <h3>Edit User</h3>
        <input id="editUsername" class="modal-input" placeholder="New Username">
        <input id="editEmail" class="modal-input" placeholder="New Email">
        <button class="modal-btn yes-btn" id="editSave">Save</button>
        <button class="modal-btn no-btn" onclick="closeEdit()">Cancel</button>
    </div>
</div>

<!-- ADD USER MODAL -->
<div id="addModal" class="modal-bg">
    <div class="modal-box">
        <h3>Add User</h3>
        <input id="addUsername" class="modal-input" placeholder="Username">
        <input id="addEmail" class="modal-input" placeholder="Email">
        <input id="addPassword" class="modal-input" placeholder="Password">
        <button class="modal-btn yes-btn" onclick="submitAdd()">Create</button>
        <button class="modal-btn no-btn" onclick="closeAdd()">Cancel</button>
    </div>
</div>

<script>

let deleteUserId = null;
let editUserId = null;

/* DELETE */
function openDeleteConfirm(id) {
    deleteUserId = id;
    document.getElementById("deleteModal").style.display = "flex";
}
function closeDelete() {
    document.getElementById("deleteModal").style.display = "none";
}
document.getElementById("deleteYes").onclick = function() {
    window.location.href = `/admin/delete_user/${deleteUserId}`;
};

/* EDIT */
function openEditUser(id) {
    editUserId = id;
    const row = document.querySelector(`tr[data-id='${id}']`);
    document.getElementById("editUsername").value = row.dataset.username;
    document.getElementById("editEmail").value = row.dataset.email;
    document.getElementById("editModal").style.display = "flex";
}
function closeEdit() {
    document.getElementById("editModal").style.display = "none";
}
document.getElementById("editSave").onclick = function () {
    const newU = document.getElementById("editUsername").value;
    const newE = document.getElementById("editEmail").value;

    window.location.href = `/admin/edit_user/${editUserId}?username=${newU}&email=${newE}`;
};

/* ADD USER */
function openAddUser() {
    document.getElementById("addModal").style.display = "flex";
}
function closeAdd() {
    document.getElementById("addModal").style.display = "none";
}
function submitAdd() {
    const u = document.getElementById("addUsername").value;
    const e = document.getElementById("addEmail").value;
    const p = document.getElementById("addPassword").value;

    window.location.href = `/admin/add_user?username=${u}&email=${e}&password=${p}`;
}

/* LIVE SEARCH */
const search = document.getElementById("searchInput");
search.addEventListener("keyup", () => {
    const term = search.value.toLowerCase();
    document.querySelectorAll("#userTable tr").forEach((row, i) => {
        if (i === 0) return;
        row.style.display =
            row.innerText.toLowerCase().includes(term) ? "" : "none";
    });
});

</script>

{% endblock %}